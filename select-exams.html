<!doctype html>
<html lang="en">
  <head>
    <title>Select Your GCSE Exams</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .exam-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: transform 0.2s;
      }
      .exam-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.15);
      }
      .search-box {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
      }
      .exam-checkbox {
        width: 20px;
        height: 20px;
      }
      .loading {
        opacity: 0.7;
        pointer-events: none;
      }
    </style>
  </head>
  <body class="img js-fullheight" style="background-image: url(images/bg.jpg);">
    <section class="ftco-section">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-10">
            <div class="p-4" style="background: rgba(0, 0, 0, 0.7); border-radius: 15px;">
              <h2 class="text-center text-white mb-4">Select Your GCSE Exams</h2>
              
              <!-- Search Filters -->
              <div class="row mb-4">
                <div class="col-md-6 mb-3">
                  <input 
                    type="text" 
                    id="subject-search" 
                    class="form-control search-box" 
                    placeholder="Search by subject..."
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <input 
                    type="text" 
                    id="board-search" 
                    class="form-control search-box" 
                    placeholder="Search by exam board..."
                  />
                </div>
              </div>

              <!-- Exam List Container -->
              <div id="exam-list" class="row">
                <!-- Exams will be loaded here -->
              </div>

              <!-- Loading Message -->
              <div id="loading-message" class="text-center text-white my-4" style="display: none;">
                Loading exams...
              </div>

              <!-- No Results Message -->
              <div id="no-results" class="text-center text-white my-4" style="display: none;">
                No exams found matching your search.
              </div>

              <!-- Buttons -->
              <div class="text-center mt-4">
                <button id="save-button" class="btn btn-primary px-4 me-2">Save Selections</button>
                <a href="dashboard.html" class="btn btn-secondary px-4">Cancel</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

      const SUPABASE_URL = 'https://rcrsslbqoukogbvdvwrz.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjcnNzbGJxb3Vrb2didmR2d3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg2OTM5MTUsImV4cCI6MjA1NDI2OTkxNX0.11uWp9T-q2Zw2qcj19Z6ahmXc_aXTf0oUZsdIKkW_dQ';

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      let allExams = [];
      let currentSession = null;

      // Format date for display
      function formatDate(dateStr) {
        if (!dateStr) return 'TBC';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }

      // Format time for display
      function formatTime(timeStr) {
        return timeStr || 'TBC';
      }

      // Show loading state
      function showLoading(show) {
        document.getElementById('loading-message').style.display = show ? 'block' : 'none';
        document.getElementById('exam-list').style.display = show ? 'none' : 'flex';
      }

      // Check authentication
      async function checkAuth() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.href = 'login.html';
          return null;
        }
        currentSession = session;
        return session;
      }

      // Load and display exams
      async function loadExams() {
        try {
          showLoading(true);

          // Get all exams
          const { data: exams, error: examsError } = await supabase
            .from('gcsedata')
            .select('*')
            .order('Date', { ascending: true });

          if (examsError) throw examsError;

          // Get user's existing selections
          const { data: userExams, error: userExamsError } = await supabase
            .from('user_exams')
            .select('exam_id')
            .eq('user_id', currentSession.user.id);

          if (userExamsError) throw userExamsError;

          allExams = exams;
          const excludedExamIds = userExams?.map(ue => ue.exam_id) || [];
          filterAndDisplayExams(excludedExamIds);

        } catch (err) {
          console.error('Error loading exams:', err);
          alert('Failed to load exams. Please try again.');
        } finally {
          showLoading(false);
        }
      }

      // Filter and display exams
      function filterAndDisplayExams(excludedExamIds = []) {
        const subjectSearch = document.getElementById('subject-search').value.toLowerCase();
        const boardSearch = document.getElementById('board-search').value.toLowerCase();

        const filteredExams = allExams.filter(exam => 
          exam.Subject?.toLowerCase().includes(subjectSearch) &&
          exam.Board?.toLowerCase().includes(boardSearch)
        );

        const examList = document.getElementById('exam-list');
        const noResults = document.getElementById('no-results');

        if (filteredExams.length === 0) {
          examList.style.display = 'none';
          noResults.style.display = 'block';
          return;
        }

        noResults.style.display = 'none';
        examList.style.display = 'flex';
        examList.innerHTML = filteredExams.map(exam => `
          <div class="col-md-6 mb-3">
            <div class="exam-card">
              <div class="form-check">
                <input class="form-check-input exam-checkbox" 
                       type="checkbox" 
                       value="${exam.id}"
                       id="exam-${exam.id}"
                       ${!excludedExamIds.includes(exam.id) ? 'checked' : ''}>
                <label class="form-check-label text-white" for="exam-${exam.id}">
                  <strong class="d-block">${exam.Subject}</strong>
                  <span class="d-block text-light">${exam.Board}</span>
                  <small class="d-block text-light">
                    Date: ${formatDate(exam.Date)}<br>
                    Time: ${formatTime(exam.Time)}<br>
                    Length: ${exam.Length || 'TBC'}
                  </small>
                </label>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Save exam selections
      async function saveSelections() {
        const saveButton = document.getElementById('save-button');
        const selectedExams = Array.from(document.querySelectorAll('.exam-checkbox:checked'))
          .map(cb => parseInt(cb.value));

        if (selectedExams.length === 0) {
          alert('Please select at least one exam');
          return;
        }

        try {
          saveButton.disabled = true;
          saveButton.textContent = 'Saving...';

          // Delete existing selections
          const { error: deleteError } = await supabase
            .from('user_exams')
            .delete()
            .eq('user_id', currentSession.user.id);

          if (deleteError) throw deleteError;

          // Insert records for non-selected exams
          const notSelectedExams = allExams
            .filter(exam => !selectedExams.includes(exam.id))
            .map(exam => ({
              user_id: currentSession.user.id,
              exam_id: exam.id
            }));

          if (notSelectedExams.length > 0) {
            const { error: insertError } = await supabase
              .from('user_exams')
              .insert(notSelectedExams);

            if (insertError) throw insertError;
          }

          window.location.href = 'dashboard.html';
        } catch (err) {
          console.error('Error saving selections:', err);
          alert('Failed to save selections. Please try again.');
          saveButton.disabled = false;
          saveButton.textContent = 'Save Selections';
        }
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', async () => {
        const session = await checkAuth();
        if (!session) return;

        await loadExams();

        // Add event listeners
        document.getElementById('subject-search').addEventListener('input', () => filterAndDisplayExams());
        document.getElementById('board-search').addEventListener('input', () => filterAndDisplayExams());
        document.getElementById('save-button').addEventListener('click', saveSelections);
      });
    </script>
  </body>
</html>