<!doctype html>
<html lang="en">
  <head>
    <title>GCSE Timetable Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      /* ============================ General Styles ============================ */
      body {
        background-color: #282c34;
        background-image: url(images/bg.jpg);
        background-size: cover;
        background-attachment: fixed;
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      /* ============================ Tab Navigation ============================ */
      .tab-navigation {
        margin: 20px 0;
        background: rgba(0,0,0,0.5);
        border-radius: 10px;
        overflow: hidden;
      }
      .tab-navigation .nav-link {
        color: white;
        padding: 15px 20px;
        border-radius: 0;
        transition: all 0.3s;
      }
      .tab-navigation .nav-link.active {
        background-color: rgba(255,215,0,0.2);
        color: #ffd700;
        font-weight: bold;
      }
      .tab-navigation .nav-link:hover:not(.active) {
        background-color: rgba(255,255,255,0.1);
      }
      .tab-content > .tab-pane {
        display: none;
      }
      .tab-content > .active {
        display: block;
      }
      /* ============================ Card and Timeline Styles ============================ */
      .week-container {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        margin-bottom: 20px;
        overflow: hidden;
      }
      .week-header {
        background: rgba(0,0,0,0.3);
        padding: 10px 15px;
        color: white;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .current-week {
        background: rgba(25,135,84,0.3);
      }
      .exam-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        padding: 15px;
      }
      .exam-card {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 15px;
        color: white;
        transition: transform 0.2s;
      }
      .exam-card:hover {
        transform: translateY(-2px);
        background: rgba(255,255,255,0.1);
      }
      .exam-card.red {
        border-left: 4px solid #ff4d4d;
        background-color: rgba(255,0,0,0.2);
      }
      .exam-card.orange {
        border-left: 4px solid #ffa500;
        background-color: rgba(255,165,0,0.2);
      }
      .exam-card.yellow {
        border-left: 4px solid #ffd700;
        background-color: rgba(255,215,0,0.2);
      }
      .exam-card.green {
        border-left: 4px solid #00ff00;
        background-color: rgba(0,255,0,0.2);
      }
      .exam-date {
        color: #ffd700;
        font-weight: bold;
      }
      .exam-time {
        color: #98fb98;
      }
      /* ============================ Controls and Display ============================ */
      .controls-container {
        background: rgba(0,0,0,0.5);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
      }
      .datetime-display {
        color: #98fb98;
        font-family: monospace;
        font-size: 1.1em;
      }
      .user-info {
        color: #ffd700;
      }
      .countdown {
        margin-top: 8px;
        font-size: 0.9em;
        color: #ff9999;
      }
      .exact-countdown {
        font-weight: bold;
        color: #ff9999;
      }
      /* ============================ Revision Timetable ============================ */
      .revision-container {
        background: rgba(0,0,0,0.5);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .revision-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .revision-table {
        width: 100%;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        overflow: hidden;
      }
      .revision-table th {
        background: rgba(0,0,0,0.4);
        color: #ffd700;
        padding: 12px;
        text-align: left;
      }
      .revision-table td {
        padding: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
      .revision-table tr:last-child td {
        border-bottom: none;
      }
      .revision-priority {
        display: inline-block;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        text-align: center;
        line-height: 25px;
        font-weight: bold;
        margin-right: 8px;
      }
      .priority-high {
        background-color: #ff4d4d;
      }
      .priority-medium {
        background-color: #ffa500;
      }
      .priority-low {
        background-color: #ffd700;
      }
      .priority-none {
        background-color: #00ff00;
      }
      /* ============================ Hardness Rating ============================ */
      .hardness-container {
        background: rgba(0,0,0,0.5);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .hardness-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
      }
      .hardness-item {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 15px;
        transition: transform 0.2s;
      }
      .hardness-item:hover {
        transform: translateY(-2px);
        background: rgba(255,255,255,0.1);
      }
      .hardness-controls {
        display: flex;
        align-items: center;
        margin-top: 10px;
      }
      .hardness-rating {
        display: flex;
        margin-right: 10px;
      }
      .hardness-star {
        color: #aaa;
        cursor: pointer;
        font-size: 1.5rem;
        transition: color 0.2s;
      }
      .hardness-star.active {
        color: #ffd700;
      }
      /* ============================ Stats Section ============================ */
      .stats-container {
        background: rgba(0,0,0,0.4);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-3px);
        background: rgba(255,255,255,0.1);
      }
      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #ffd700;
      }
      .stat-label {
        color: #98fb98;
        text-transform: uppercase;
        font-size: 0.9rem;
        margin-top: 5px;
      }
      /* ============================ Loading and Alerts ============================ */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #ffd700;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .next-exam-alert {
        background: rgba(255,215,0,0.15);
        border-left: 4px solid #ffd700;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        color: white;
      }
      /* New styles for revision recommendations */
      .revision-recommendation {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .revision-day {
        font-weight: bold;
        font-size: 1.1rem;
        color: #ffd700;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 8px;
        margin-bottom: 10px;
      }
      .revision-session {
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 4px;
        background: rgba(0,0,0,0.2);
      }
      .revision-subject {
        font-weight: bold;
      }
      .revision-time {
        float: right;
        color: #98fb98;
      }
      .revision-activity {
        font-style: italic;
        color: #ccc;
        font-size: 0.9rem;
      }
      .revision-break {
        padding: 5px 8px;
        margin: 8px 0;
        border-radius: 4px;
        background: rgba(25,135,84,0.2);
        color: #98fb98;
        font-size: 0.9rem;
        text-align: center;
      }
      .weekly-balance {
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .balance-label {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .balance-bar {
        height: 25px;
        border-radius: 4px;
        margin-bottom: 5px;
        display: flex;
        overflow: hidden;
      }
      .balance-segment {
        height: 100%;
        display: inline-block;
        text-align: center;
        color: black;
        font-size: 0.8rem;
        line-height: 25px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* Custom view tab styles */
      .revision-view-tabs {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 15px;
      }
      .revision-view-tabs .nav-link {
        color: #ffffff;
        background: rgba(0,0,0,0.2);
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        padding: 10px 15px;
      }
      .revision-view-tabs .nav-link.active {
        background: rgba(255,215,0,0.2);
        color: #ffd700;
        border-bottom: 2px solid #ffd700;
      }
    </style>
  </head>
  <body>
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
    </div>
    <div class="container my-4">
      <!-- Controls -->
      <div class="controls-container">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <div>
            <h2 class="text-white mb-2">My GCSE Timetable</h2>
            <div class="user-info mb-1" id="user-info">Current User's Login: Valinor-70</div>
            <div class="datetime-display" id="datetime-display">Current Date and Time (UTC - YYYY-MM-DD HH:MM:SS formatted): 2025-05-08 10:12:50</div>
          </div>
          <div>
            <button id="select-exams-btn" class="btn btn-primary me-2">Select Exams</button>
            <button id="logout-btn" class="btn btn-danger">Logout</button>
          </div>
        </div>
      </div>
      <!-- Next Exam Alert -->
      <div id="next-exam-alert" class="next-exam-alert">
        <div class="d-flex align-items-center">
          <i class="fas fa-bell fa-lg me-3"></i>
          <div>
            <h5 class="mb-1" id="next-exam-title">Loading next exam...</h5>
            <p class="mb-0" id="next-exam-details"></p>
            <p class="mb-0 mt-2 exact-countdown" id="exact-countdown"></p>
          </div>
        </div>
      </div>
      <!-- Statistics Overview -->
      <div class="stats-container mb-4">
        <div class="row">
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div><i class="fas fa-calendar-day fa-2x mb-2" style="color: #98fb98;"></i></div>
              <div class="stat-value" id="total-exams">0</div>
              <div class="stat-label">Total Exams</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div><i class="fas fa-book fa-2x mb-2" style="color: #98fb98;"></i></div>
              <div class="stat-value" id="unique-subjects">0</div>
              <div class="stat-label">Subjects</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div><i class="fas fa-hourglass-start fa-2x mb-2" style="color: #98fb98;"></i></div>
              <div class="stat-value" id="days-to-next">0</div>
              <div class="stat-label">Days to Next</div>
            </div>
          </div>
          <div class="col-md-3 col-6 mb-3">
            <div class="stat-card">
              <div><i class="fas fa-check-circle fa-2x mb-2" style="color: #98fb98;"></i></div>
              <div class="stat-value" id="completed-exams">0</div>
              <div class="stat-label">Completed</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs tab-navigation" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="timetable-tab" data-bs-toggle="tab" data-bs-target="#timetable" type="button" role="tab" aria-controls="timetable" aria-selected="true">
            <i class="fas fa-calendar-alt me-2"></i>Timetable
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="revision-tab" data-bs-toggle="tab" data-bs-target="#revision" type="button" role="tab" aria-controls="revision" aria-selected="false">
            <i class="fas fa-tasks me-2"></i>Revision Plan
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="hardness-tab" data-bs-toggle="tab" data-bs-target="#hardness" type="button" role="tab" aria-controls="hardness" aria-selected="false">
            <i class="fas fa-sliders-h me-2"></i>Set Hardness
          </button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <!-- Timetable Tab -->
        <div class="tab-pane fade show active" id="timetable" role="tabpanel" aria-labelledby="timetable-tab">
          <div id="loading-message" class="text-center my-4 p-4" style="display: none; background: rgba(0,0,0,0.5); border-radius: 10px;">
            Loading your timetable...
          </div>
          <div id="no-exams-message" class="text-center my-4 p-5" style="display: none; background: rgba(0,0,0,0.5); border-radius: 10px;">
            <h4>No exams selected yet!</h4>
            <p class="mb-4">Please select the exams you're doing to see your schedule.</p>
            <button id="select-exams-btn-main" class="btn btn-primary btn-lg">Select My Exams</button>
          </div>
          <div id="weeks-container"></div>
        </div>
        <!-- Revision Tab -->
        <div class="tab-pane fade" id="revision" role="tabpanel" aria-labelledby="revision-tab">
          <div class="revision-container">
            <div class="revision-header">
              <h4><i class="fas fa-tasks me-2"></i>Revision Timetable</h4>
              <button id="generate-revision-btn" class="btn btn-warning">
                <i class="fas fa-sync-alt me-2"></i>Generate Plan
              </button>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i> Your revision plan is based on exam proximity, subject difficulty, and balanced study time allocation. The plan keeps all subjects in rotation while prioritizing urgent exams.
            </div>
            <div id="revision-loading" class="text-center py-4" style="display: none;">
              <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Generating your personalized revision plan...</p>
            </div>
            <div id="no-revision-data" class="alert alert-warning" style="display: none;">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Please ensure your exam hardness is set.
            </div>
            <div id="revision-overview">
              <div class="weekly-balance mb-4">
                <div class="balance-label">Weekly Study Time Distribution</div>
                <div id="balance-bar" class="balance-bar"></div>
                <div id="balance-legend" class="d-flex flex-wrap mt-2"></div>
              </div>
              
              <ul class="nav nav-tabs mb-4 revision-view-tabs" id="revision-view-tabs">
                <li class="nav-item">
                  <a class="nav-link active" id="table-view-tab" data-bs-toggle="tab" data-bs-target="#table-view" href="#">Table View</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="daily-view-tab" data-bs-toggle="tab" data-bs-target="#daily-view" href="#">Daily Schedule</a>
                </li>
              </ul>
              
              <div class="tab-content">
                <div class="tab-pane fade show active" id="table-view">
                  <div id="revision-table-container">
                    <table class="revision-table" id="revision-table">
                      <thead>
                        <tr>
                          <th>Priority</th>
                          <th>Subject</th>
                          <th>Exam Date</th>
                          <th>Days Left</th>
                          <th>Difficulty</th>
                          <th>Weekly Hours</th>
                          <th>Focus Areas</th>
                        </tr>
                      </thead>
                      <tbody id="revision-tbody"></tbody>
                    </table>
                  </div>
                </div>
                <div class="tab-pane fade" id="daily-view">
                  <div id="daily-schedule-container"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Hardness Tab -->
        <div class="tab-pane fade" id="hardness" role="tabpanel" aria-labelledby="hardness-tab">
          <div class="hardness-container">
            <h4 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Rate Exam Difficulty</h4>
            <p class="mb-4">Rate each exam's difficulty from 1 (Easy) to 5 (Very Hard) to help optimize your revision timetable.</p>
            <div id="hardness-loading" class="text-center py-4">
              <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading your exams...</p>
            </div>
            <div id="hardness-list" class="hardness-list"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Main JavaScript Implementation -->
    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
      
      // Supabase credentials and client
      const SUPABASE_URL = 'https://rcrsslbqoukogbvdvwrz.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjcnNzbGJxb3Vrb2didmR2d3J6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg2OTM5MTUsImV4cCI6MjA1NDI2OTkxNX0.11uWp9T-q2Zw2qcj19Z6ahmXc_aXTf0oUZsdIKkW_dQ';
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // Global variables
      let CURRENT_DATE = new Date();
      let USER_EXAMS = []; // Exams the user is doing (after filtering out those they are not doing).
      let HARDNESS_DATA = {}; // Hardness ratings, keyed by exam id.
      let NEXT_EXAM = null;
      let TIMER_INTERVAL;
      
      // DOM Elements
      const loadingOverlay = document.getElementById('loading-overlay');
      const datetimeDisplay = document.getElementById('datetime-display');
      const userInfoDisplay = document.getElementById('user-info');
      const exactCountdown = document.getElementById('exact-countdown');
      const weeksContainer = document.getElementById('weeks-container');
      const noExamsMessage = document.getElementById('no-exams-message');
      const loadingMessage = document.getElementById('loading-message');
      const nextExamAlert = document.getElementById('next-exam-alert');
      const nextExamTitle = document.getElementById('next-exam-title');
      const nextExamDetails = document.getElementById('next-exam-details');
      
      // Stats elements
      const totalExamsElement = document.getElementById('total-exams');
      const uniqueSubjectsElement = document.getElementById('unique-subjects');
      const daysToNextElement = document.getElementById('days-to-next');
      const completedExamsElement = document.getElementById('completed-exams');
      
      // Revision elements
      const revisionOverview = document.getElementById('revision-overview');
      const revisionTableContainer = document.getElementById('revision-table-container');
      const revisionLoading = document.getElementById('revision-loading');
      const noRevisionData = document.getElementById('no-revision-data');
      const revisionTbody = document.getElementById('revision-tbody');
      const dailyScheduleContainer = document.getElementById('daily-schedule-container');
      const balanceBar = document.getElementById('balance-bar');
      const balanceLegend = document.getElementById('balance-legend');
      
      // Hardness elements
      const hardnessList = document.getElementById('hardness-list');
      const hardnessLoading = document.getElementById('hardness-loading');
      
      /**
       * Format a date string ("DD/MM/YY") into a formatted date.
       */
      function formatDate(dateStr) {
        if (!dateStr) return 'TBC';
        const [day, month, year] = dateStr.split('/');
        const fullYear = year.length === 2 ? '20' + year : year;
        try {
          const date = new Date(`${fullYear}-${month}-${day}`);
          return date.toLocaleDateString('en-GB', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
        } catch(e) {
          console.error('Error formatting date:', dateStr, e);
          return dateStr;
        }
      }
      
      /**
       * Parse exam date string ("DD/MM/YY") into a Date object.
       */
      function parseExamDate(dateStr) {
        if (!dateStr) return null;
        try {
          const [day, month, year] = dateStr.split('/');
          const fullYear = year.length === 2 ? '20' + year : year;
          const date = new Date(`${fullYear}-${month}-${day}T00:00:00Z`);
          return date.getTime() ? date : null;
        } catch(e) {
          console.error('Error parsing date:', dateStr, e);
          return null;
        }
      }
      
      /**
       * Calculate days until an exam.
       */
      function calculateDaysUntil(dateStr) {
        const examDate = parseExamDate(dateStr);
        if (!examDate) return null;
        const examDay = new Date(examDate);
        examDay.setHours(0,0,0,0);
        const today = new Date(CURRENT_DATE);
        today.setHours(0,0,0,0);
        const diffTime = examDay - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }
      
      /**
       * Return a CSS class based on days until the exam.
       */
      function getExamHighlightClass(daysUntil) {
        if (daysUntil <= 2) return 'red';
        if (daysUntil <= 5) return 'orange';
        if (daysUntil <= 7) return 'yellow';
        return 'green';
      }
      
      /**
       * Update the current date/time display and countdown timer.
       */
      function updateDateTime() {
        // Format date in YYYY-MM-DD HH:MM:SS format
        CURRENT_DATE = new Date(CURRENT_DATE.getTime() + 1000); // Add 1 second
        const year = CURRENT_DATE.getUTCFullYear();
        const month = String(CURRENT_DATE.getUTCMonth() + 1).padStart(2, '0');
        const day = String(CURRENT_DATE.getUTCDate()).padStart(2, '0');
        const hours = String(CURRENT_DATE.getUTCHours()).padStart(2, '0');
        const minutes = String(CURRENT_DATE.getUTCMinutes()).padStart(2, '0');
        const seconds = String(CURRENT_DATE.getUTCSeconds()).padStart(2, '0');
        
        const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        datetimeDisplay.textContent = `Current Date and Time (UTC - YYYY-MM-DD HH:MM:SS formatted): ${formattedDate}`;
        userInfoDisplay.textContent = `Current User's Login: Valinor-70`;
        updateExactCountdown();
      }
      
      /**
       * Update the exact countdown to the next exam.
       */
      function updateExactCountdown() {
        if (!NEXT_EXAM || !NEXT_EXAM.Date) {
          exactCountdown.textContent = '';
          return;
        }
        const examDate = parseExamDate(NEXT_EXAM.Date);
        if (!examDate) {
          exactCountdown.textContent = '';
          return;
        }
        let examDateTime = new Date(examDate);
        if (NEXT_EXAM.Time && NEXT_EXAM.Time.toLowerCase().includes('pm')) {
          examDateTime.setHours(13,30,0,0);
        } else {
          examDateTime.setHours(9,30,0,0);
        }
        const now = new Date(CURRENT_DATE);
        const diffMs = examDateTime - now;
        if (diffMs <= 0) {
          exactCountdown.textContent = 'Exam has started!';
          return;
        }
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs % (1000*60*60*24)) / (1000*60*60));
        const minutes = Math.floor((diffMs % (1000*60*60)) / (1000*60));
        const seconds = Math.floor((diffMs % (1000*60)) / 1000);
        exactCountdown.textContent = `Countdown: ${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
      }
      
      /**
       * Group exams by week.
       */
      function groupExamsByWeek(exams) {
        const weeks = {};
        exams.forEach(exam => {
          const week = exam.Week || 'Unscheduled';
          if (!weeks[week]) {
            weeks[week] = { exams: [], isCurrent: false };
          }
          weeks[week].exams.push(exam);
        });
        const today = new Date(CURRENT_DATE);
        const currentWeekExams = exams.filter(exam => {
          const examDate = parseExamDate(exam.Date);
          if (!examDate) return false;
          const diffDays = Math.round((examDate - today) / (1000*60*60*24));
          return diffDays >= 0 && diffDays < 7;
        });
        if (currentWeekExams.length > 0) {
          const currentWeek = currentWeekExams[0].Week;
          if (weeks[currentWeek]) weeks[currentWeek].isCurrent = true;
        }
        return weeks;
      }
      
      /**
       * Render a week section.
       */
      function renderWeek(weekNumber, weekData) {
        const { exams, isCurrent } = weekData;
        return `
          <div class="week-container ${isCurrent ? 'current-week' : ''}">
            <div class="week-header">
              <span>Week ${weekNumber}</span>
              ${isCurrent ? '<span class="badge bg-success">Current Week</span>' : ''}
            </div>
            <div class="exam-grid">
              ${exams.map(exam => {
                const daysUntil = calculateDaysUntil(exam.Date);
                const highlightClass = getExamHighlightClass(daysUntil);
                // Use the hardness value if already loaded; otherwise display "Not rated"
                const hardness = HARDNESS_DATA[exam.id] !== undefined ? HARDNESS_DATA[exam.id] : 'Not rated';
                return `
                  <div class="exam-card ${highlightClass}">
                    <div class="exam-date">${formatDate(exam.Date)}</div>
                    <div class="h5 mb-1">${exam.Subject}</div>
                    <div class="badge bg-secondary mb-2">${exam.Board}</div>
                    <div class="exam-time">
                      <i class="far fa-clock"></i> Time: ${exam.Time || 'TBC'}<br>
                      <i class="fas fa-hourglass-half"></i> Length: ${exam.Length || 'TBC'}
                    </div>
                    <div class="mt-2">
                      <span class="badge bg-info">Difficulty: ${hardness}</span>
                    </div>
                    ${daysUntil !== null ? `
                    <div class="countdown">
                      <i class="fas fa-calendar-day"></i> ${daysUntil} days away
                    </div>` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      /**
       * Compute an exam's timestamp (AM: 9:30, PM: 13:30).
       */
      function computeExamTimestamp(exam) {
        const examDate = parseExamDate(exam.Date);
        if (!examDate) return Infinity;
        const examDateTime = new Date(examDate);
        if (exam.Time && exam.Time.toLowerCase().includes('pm')) {
          examDateTime.setHours(13,30,0,0);
        } else {
          examDateTime.setHours(9,30,0,0);
        }
        return examDateTime.getTime();
      }
      
      /**
       * Find the next exam (earliest exam).
       */
      function findNextExam(exams) {
        if (!exams || exams.length === 0) return null;
        const upcomingExams = exams.filter(exam => computeExamTimestamp(exam) >= Date.now());
        if (upcomingExams.length === 0) return null;
        upcomingExams.sort((a, b) => computeExamTimestamp(a) - computeExamTimestamp(b));
        return upcomingExams[0];
      }
      
      /**
       * Update statistics display.
       */
      function updateStatistics(exams) {
  if (!exams || exams.length === 0) {
    totalExamsElement.textContent = '0';
    uniqueSubjectsElement.textContent = '0';
    daysToNextElement.textContent = '0';
    completedExamsElement.textContent = '0';
    return;
  }

  const totalExams = exams.length;
  const uniqueSubjects = [...new Set(exams.map(exam => exam.Subject))].length;

  // Use the current time instead of just the start of the day
  const currentTime = new Date(CURRENT_DATE);

  const completedExams = exams.filter(exam => {
    const examDate = parseExamDate(exam.Date);
    return examDate && examDate <= currentTime; // Includes exams completed earlier on the same day
  }).length;

  NEXT_EXAM = findNextExam(exams);
  const daysToNext = NEXT_EXAM ? calculateDaysUntil(NEXT_EXAM.Date) : 0;

  totalExamsElement.textContent = totalExams;
  uniqueSubjectsElement.textContent = uniqueSubjects;
  daysToNextElement.textContent = daysToNext;
  completedExamsElement.textContent = completedExams;

  if (NEXT_EXAM) {
    nextExamTitle.textContent = daysToNext === 0 ? 'Your exam is TODAY!' :
      daysToNext === 1 ? 'Your exam is TOMORROW!' : `Your next exam is in ${daysToNext} days`;
    nextExamDetails.textContent = `${NEXT_EXAM.Subject} (${NEXT_EXAM.Board}) - ${formatDate(NEXT_EXAM.Date)}, ${NEXT_EXAM.Time || 'Time TBC'}`;
    nextExamAlert.style.display = 'block';
  } else {
    nextExamAlert.style.display = 'none';
  }
}
      
      /**
       * Get the appropriate study activity based on subject and days until exam
       */
      function getStudyActivity(subject, daysUntil) {
        const activities = [
          "Content review",
          "Practice questions",
          "Past paper",
          "Mind mapping",
          "Flashcards",
          "Summary writing"
        ];
        
        if (daysUntil <= 3) {
          return "Past paper practice & reviewing weak areas";
        } else if (daysUntil <= 7) {
          return "Practice questions & timed exercises";
        } else if (daysUntil <= 14) {
          return "Content review & practice questions";
        } else {
          return "Core concept review & knowledge building";
        }
      }
      
      /**
       * Get a random color for a subject that's visually distinct
       */
      function getSubjectColor(subject, index) {
        const colors = [
          "#FF6B6B", "#4ECDC4", "#FFD166", "#06D6A0", 
          "#118AB2", "#EF476F", "#73D2DE", "#FFC43D",
          "#1B9AAA", "#6A4C93", "#F79256", "#00AFB9"
        ];
        return colors[index % colors.length];
      }
      
      /**
       * Generate the revision timetable based on USER_EXAMS.
       * For any exam with missing hardness, default to 3.
       */
      async function generateRevisionTimetable() {
        revisionLoading.style.display = 'block';
        revisionOverview.style.display = 'none';
        noRevisionData.style.display = 'none';
        
        try {
          const today = new Date(CURRENT_DATE);
          today.setHours(0,0,0,0);
          
          // Get upcoming exams
          const upcomingExams = USER_EXAMS.filter(exam => {
            const examDate = parseExamDate(exam.Date);
            return examDate && examDate >= today;
          });
          
          if (upcomingExams.length === 0) {
            revisionLoading.style.display = 'none';
            noRevisionData.style.display = 'block';
            noRevisionData.textContent = 'No upcoming exams found.';
            return;
          }
          
          // Get unique subjects
          const subjects = [...new Set(upcomingExams.map(exam => exam.Subject))];
          
          // Process each exam with realistic metrics
          const prioritizedExams = upcomingExams.map(exam => {
            const daysUntil = calculateDaysUntil(exam.Date) || 999;
            const hardness = HARDNESS_DATA[exam.id] !== undefined ? HARDNESS_DATA[exam.id] : 3;
            
            // Calculate priority score (weighted combination of days and difficulty)
            let urgencyScore = 0;
            if (daysUntil <= 7) urgencyScore = 5;
            else if (daysUntil <= 14) urgencyScore = 4;
            else if (daysUntil <= 21) urgencyScore = 3;
            else if (daysUntil <= 30) urgencyScore = 2;
            else urgencyScore = 1;
            
            const priorityScore = (urgencyScore * 0.7) + (hardness * 0.3);
            
            // Calculate weekly hours (more realistic)
            let weeklyHours = 0;
            if (daysUntil <= 7) {
              // More time for immediate exams, scaled by difficulty
              weeklyHours = 4 + (hardness * 0.5);
            } else if (daysUntil <= 14) {
              weeklyHours = 3 + (hardness * 0.4);
            } else if (daysUntil <= 21) {
              weeklyHours = 2 + (hardness * 0.3);
            } else {
              // Base maintenance revision
              weeklyHours = 1 + (hardness * 0.2);
            }
            
            // Suggested focus areas based on time remaining
            let focusAreas = getStudyActivity(exam.Subject, daysUntil);
            
            return { 
              ...exam, 
              daysUntil, 
              hardness, 
              priorityScore, 
              weeklyHours: Math.round(weeklyHours * 10) / 10,
              focusAreas
            };
          });
          
          // Sort by priority
          prioritizedExams.sort((a, b) => b.priorityScore - a.priorityScore);
          
          // Calculate total weekly study hours
          const totalWeeklyHours = prioritizedExams.reduce((total, exam) => total + exam.weeklyHours, 0);
          
          // Render the table view
          revisionTbody.innerHTML = prioritizedExams.map((exam, index) => {
            let priorityClass = 'priority-none';
            if (index === 0) priorityClass = 'priority-high';
            else if (index < 3) priorityClass = 'priority-medium';
            else if (index < 5) priorityClass = 'priority-low';
            
            return `
              <tr>
                <td><span class="revision-priority ${priorityClass}">${index + 1}</span></td>
                <td>${exam.Subject}</td>
                <td>${formatDate(exam.Date)}</td>
                <td>${exam.daysUntil}</td>
                <td>${exam.hardness}/5</td>
                <td>${exam.weeklyHours} hrs</td>
                <td>${exam.focusAreas}</td>
              </tr>
            `;
          }).join('');
          
          // Render weekly balance visualization
          balanceBar.innerHTML = '';
          balanceLegend.innerHTML = '';
          
          // Create a color-coded balance bar
          prioritizedExams.forEach((exam, index) => {
            const percentage = (exam.weeklyHours / totalWeeklyHours) * 100;
            const color = getSubjectColor(exam.Subject, index);
            const segment = document.createElement('div');
            segment.className = 'balance-segment';
            segment.style.width = `${percentage}%`;
            segment.style.backgroundColor = color;
            segment.title = `${exam.Subject}: ${exam.weeklyHours} hours (${Math.round(percentage)}%)`;
            
            if (percentage > 10) {
              segment.textContent = exam.Subject;
            }
            
            balanceBar.appendChild(segment);
            
            // Add to legend
            const legendItem = document.createElement('div');
            legendItem.className = 'me-3 mb-1';
            legendItem.innerHTML = `
              <span style="display:inline-block;width:15px;height:15px;background-color:${color};margin-right:5px;"></span>
              ${exam.Subject}: ${exam.weeklyHours}h
            `;
            balanceLegend.appendChild(legendItem);
          });
          
          // Generate daily schedule view
          const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
          let scheduleHTML = '';
          
          weekdays.forEach(day => {
            const isWeekend = day === 'Saturday' || day === 'Sunday';
            const maxDailyHours = isWeekend ? 4 : 2.5; // More time on weekends
            
            // Generate a daily schedule (simplified algorithm)
            let dailySchedule = [];
            let remainingExams = [...prioritizedExams];
            let totalDailyHours = 0;
            
            // First, allocate time to highest priority subjects
            while (remainingExams.length > 0 && totalDailyHours < maxDailyHours) {
              // Get the highest priority exam that hasn't been allocated yet
              const exam = remainingExams.shift();
              
              // Calculate how much time to allocate today
              // Weekly hours รท 5 weekdays (or 2 for weekends)
              const dailyAllocation = isWeekend ? 
                Math.min(exam.weeklyHours / 2, maxDailyHours - totalDailyHours) : 
                Math.min(exam.weeklyHours / 5, maxDailyHours - totalDailyHours);
              
              // Only add if we can allocate some meaningful time
              if (dailyAllocation >= 0.5) {
                totalDailyHours += dailyAllocation;
                dailySchedule.push({
                  subject: exam.Subject,
                  hours: Math.round(dailyAllocation * 10) / 10,
                  activity: exam.focusAreas,
                  priority: exam.priorityScore,
                  daysUntil: exam.daysUntil
                });
              }
            }
            
            // Format the daily schedule
            scheduleHTML += `
              <div class="revision-recommendation">
                <div class="revision-day">${day} (${Math.round(totalDailyHours * 10) / 10} hours)</div>
            `;
            
            if (dailySchedule.length === 0) {
              scheduleHTML += `<p class="text-muted">No scheduled revision for this day.</p>`;
            } else {
              dailySchedule.forEach((session, i) => {
                scheduleHTML += `
                  <div class="revision-session">
                    <span class="revision-subject">${session.subject}</span>
                    <span class="revision-time">${session.hours} hours</span>
                    <div class="revision-activity">${session.activity}</div>
                  </div>
                `;
                
                // Add break suggestions between sessions
                if (i < dailySchedule.length - 1) {
                  scheduleHTML += `<div class="revision-break">Take a 15-20 minute break</div>`;
                }
              });
            }
            
            scheduleHTML += `</div>`;
          });
          
          dailyScheduleContainer.innerHTML = scheduleHTML;
          
          // Show the revision overview
          revisionLoading.style.display = 'none';
          revisionOverview.style.display = 'block';
          
        } catch (err) {
          console.error('Error generating revision timetable:', err);
          revisionLoading.style.display = 'none';
          noRevisionData.style.display = 'block';
          noRevisionData.textContent = 'Error generating timetable. Please try again.';
        }
      }
      
      /**
       * Load user exams from Supabase.
       * Since the database stores exams the user is NOT doing, we filter those out.
       */
      async function loadUserExams() {
        loadingMessage.style.display = 'block';
        weeksContainer.style.display = 'none';
        noExamsMessage.style.display = 'none';
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            window.location.href = 'login.html';
            return;
          }
          
          // Fetch the exam IDs the user is NOT doing (from the user_exams table)
          const { data: userExamsData, error: userExamsError } = await supabase
            .from('user_exams')
            .select('exam_id')
            .eq('user_id', session.user.id);
          if (userExamsError) throw userExamsError;
          const excludedExamIds = userExamsData.map(ue => ue.exam_id);
          // Fetch all exams
          const { data: allExams, error: examsError } = await supabase
            .from('gcsedata')
            .select('*')
            .order('Date', { ascending: true });
          if (examsError) throw examsError;
          // Inverse filter: include only exams NOT listed in excludedExamIds.
          USER_EXAMS = allExams.filter(exam => !excludedExamIds.includes(exam.id));
          loadingMessage.style.display = 'none';
          if (USER_EXAMS.length === 0) {
            weeksContainer.style.display = 'none';
            noExamsMessage.style.display = 'block';
            return;
          }
          const weeklyExams = groupExamsByWeek(USER_EXAMS);
          weeksContainer.innerHTML = Object.entries(weeklyExams)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([week, data]) => renderWeek(week, data))
            .join('');
          weeksContainer.style.display = 'block';
          updateStatistics(USER_EXAMS);
        } catch (err) {
          console.error('Error loading user exams:', err);
          loadingMessage.style.display = 'none';
          weeksContainer.innerHTML = `<div class="alert alert-danger">Error loading exams: ${err.message || 'Unknown error'}</div>`;
          weeksContainer.style.display = 'block';
        }
      }
      
      /**
       * Load hardness settings.
       * This function queries the table "user_exam_hardness".
       * After loading, it re-renders the timetable so that the correct hardness ratings are displayed.
       */
      async function loadHardnessSettings() {
        hardnessLoading.style.display = 'block';
        hardnessList.innerHTML = '';
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            window.location.href = 'login.html';
            return;
          }
          if (USER_EXAMS.length === 0) {
            hardnessLoading.style.display = 'none';
            hardnessList.innerHTML = `<div class="alert alert-warning">No exams selected for hardness rating.</div>`;
            return;
          }
          // Query the table "user_exam_hardness"
          const { data: hardnessRatings, error: hardnessError } = await supabase
            .from('user_exam_hardness')
            .select('exam_id, hardness')
            .eq('user_id', session.user.id);
          if (hardnessError) throw hardnessError;
          const hardnessMap = {};
          hardnessRatings.forEach(item => {
            hardnessMap[item.exam_id] = item.hardness;
          });
          // Update the global HARDNESS_DATA variable
          HARDNESS_DATA = hardnessMap;
          hardnessList.innerHTML = USER_EXAMS.map(exam => {
            const currentHardness = HARDNESS_DATA[exam.id] || 0;
            const daysUntil = calculateDaysUntil(exam.Date);
            return `
              <div class="hardness-item">
                <div class="d-flex justify-content-between">
                  <h5>${exam.Subject}</h5>
                  <span class="badge ${daysUntil <= 7 ? 'bg-danger' : 'bg-warning'}">${daysUntil} days</span>
                </div>
                <p class="text-muted">${formatDate(exam.Date)}</p>
                <div class="hardness-controls">
                  <div class="hardness-rating" data-exam-id="${exam.id}">
                    ${[1,2,3,4,5].map(i => `
                      <i class="fas fa-star hardness-star ${i <= currentHardness ? 'active' : ''}" data-value="${i}"></i>
                    `).join('')}
                  </div>
                  <span class="ms-2">${currentHardness > 0 ? currentHardness : 'Not rated'}</span>
                </div>
              </div>
            `;
          }).join('');
          document.querySelectorAll('.hardness-rating').forEach(rating => {
            const examId = rating.getAttribute('data-exam-id');
            rating.querySelectorAll('.hardness-star').forEach(star => {
              star.addEventListener('click', async () => {
                const value = parseInt(star.getAttribute('data-value'));
                await updateHardness(examId, value);
                rating.querySelectorAll('.hardness-star').forEach(s => {
                  s.classList.toggle('active', parseInt(s.getAttribute('data-value')) <= value);
                });
                rating.nextElementSibling.textContent = value;
              });
            });
          });
          hardnessLoading.style.display = 'none';
          // Re-render the timetable now that hardness ratings have been updated.
          if (USER_EXAMS.length > 0) {
            loadUserExams();
          }
        } catch (err) {
          console.error('Error loading hardness settings:', err);
          hardnessLoading.style.display = 'none';
          hardnessList.innerHTML = `<div class="alert alert-danger">Error loading hardness settings: ${err.message || 'Unknown error'}</div>`;
        }
      }
      
      /**
       * Update hardness rating for a given exam.
       */
      async function updateHardness(examId, hardness) {
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            window.location.href = 'login.html';
            return;
          }
          const userId = session.user.id;
          // Upsert into the table "user_exam_hardness"
          const { error } = await supabase
            .from('user_exam_hardness')
            .upsert({ user_id: userId, exam_id: examId, hardness });
          if (error) throw error;
          HARDNESS_DATA[examId] = hardness;
          if (document.getElementById('timetable-tab').classList.contains('active')) {
            loadUserExams();
          }
        } catch (err) {
          console.error('Error updating hardness:', err);
          alert('Error updating hardness rating. Please try again.');
        }
      }
      
      /**
       * Initialize the dashboard.
       */
      async function initialize() {
        try {
          // Initialize the date time updater
          updateDateTime();
          TIMER_INTERVAL = setInterval(updateDateTime, 1000);
          
          // Load data
          await loadUserExams();
          await loadHardnessSettings();
          
          // Generate initial revision plan
          await generateRevisionTimetable();
          
          // Remove loading overlay
          loadingOverlay.style.display = 'none';
        } catch (err) {
          console.error('Error initializing app:', err);
          loadingOverlay.style.display = 'none';
        }
      }
      
      // Fix tab switching
      function setupTabSwitching() {
        const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabLinks.forEach(tabLink => {
          tabLink.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Remove active class from all tabs and panes
            document.querySelectorAll('.nav-link').forEach(tab => {
              tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
              pane.classList.remove('show', 'active');
            });
            
            // Add active class to clicked tab
            tabLink.classList.add('active');
            
            // Add active class to corresponding pane
            const targetSelector = tabLink.getAttribute('data-bs-target');
            const targetPane = document.querySelector(targetSelector);
            if (targetPane) {
              targetPane.classList.add('show', 'active');
            }
          });
        });
      }
      
      // Event listeners
      document.addEventListener('DOMContentLoaded', () => {
        initialize();
        setupTabSwitching();
        
        document.querySelectorAll('#select-exams-btn, #select-exams-btn-main').forEach(btn => {
          btn.addEventListener('click', () => {
            window.location.href = 'select-exams.html';
          });
        });
        
        document.getElementById('logout-btn').addEventListener('click', async () => {
          try {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
          } catch (err) {
            console.error('Error logging out:', err);
            alert('Error logging out. Please try again.');
          }
        });
        
        document.getElementById('generate-revision-btn').addEventListener('click', generateRevisionTimetable);
      });
      
      window.updateHardness = updateHardness;
    </script>
  </body>
</html>